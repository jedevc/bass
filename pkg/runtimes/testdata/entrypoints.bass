(use (.strings)
     (*dir*/lib/oci.bass))

(defn entrypoint [thunk]
  (let [config (oci:config thunk)]
    (:Entrypoint config null)))

(def not-respected
  (from (linux/alpine/git :2.36.3)
    ($ git --version)))

; entrypoint is *not* respected by ($)
(assert = "git version 2.36.3\n"
  (-> not-respected
      (read :raw)
      next))

; but it is preserved
(assert = ["git"]
  (entrypoint not-respected))

; entrypoint *is* respected when running directly
(assert strings:includes?
  (-> (linux/hello-world)
      (read :raw)
      next)
  "Hello from Docker")

(def unset-image
  (-> (linux/alpine/git :2.36.3)
      (with-entrypoint [])))

; ; entrypoint is removed when set to empty list
(assert null?
  (entrypoint unset-image))

(def set-thunk
  (-> (from (linux/busybox)
        ($ touch index.html))
      (with-entrypoint ["httpd" "-f" "-p" "8000"])))

; entrypoint can be set by thunk
(assert = ["httpd" "-f" "-p" "8000"]
  (entrypoint set-thunk))

(def keeps-entrypoint
  (from set-thunk
    ($ echo "Hello, world!")))

; entrypoint is preserved from thunk to thunk
(assert = ["httpd" "-f" "-p" "8000"]
  (entrypoint keeps-entrypoint))
